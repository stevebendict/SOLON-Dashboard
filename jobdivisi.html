        <!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Divisi Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'background-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for professional look and scrollability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3ff6;
        }
        /* Style for the active tab indicator */
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* Style for Locked ReadOnly Fields */
        .field-locked {
            @apply bg-gray-100 border-gray-200 text-gray-500 font-medium cursor-not-allowed;
        }
        /* Preview container style */
        .preview-container {
            @apply flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-6 h-40 text-gray-500;
        }
        .preview-container.has-file {
            @apply border-green-400 bg-green-50;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="p-4 md:p-8">
        <!-- Application content will be rendered here -->
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        // --- MOCK DATA (DISESUAIKAN UNTUK NOTARIS & PPAT) ---
        const MOCK_DIVISIONS = [
            // estimate date format: YYYY-MM-DD
            { 
                id: 1, 
                name: "AJB Properti A", // Nama Job Divisi tetap ada di data, tapi dihilangkan dari form input
                division: "Rina Sari", // Division (dahulu Head)
                group: "Akta Tanah (PPAT)", 
                status: "Aktif", 
                estimate: "2025-12-15", 
                job_type: 'Jual Beli', 
                type_service: 'Regular', // New field
                registration_no: 'R/2025/112/A', 
                person_in_charge: 'Joko Pramono', 
                perbantuan: ['Anya Wijaya', 'Deny Firmansyah'], // New field
                akta_date: '2025-10-30', 
                akta_place: 'Kantor Notaris Utama', 
                file_send_date: '2025-10-10', 
                notes: 'Masukkan catatan penting terkait proses akta atau berkas di sini...',
                foto_akad_url: 'https://placehold.co/400x200/4f46e5/ffffff?text=FOTO+AKAD',
                receipt_certificate_url: null,
            },
            { 
                id: 2, 
                name: "Pendirian PT Mega Karya", 
                division: "Budi Santoso", 
                group: "Akta Perusahaan (Notaris)", 
                status: "Priority", 
                estimate: "2026-01-01", 
                job_type: 'Pendirian PT', 
                type_service: 'Priority',
                registration_no: 'R/2025/113/B', 
                person_in_charge: 'Anya Wijaya', 
                perbantuan: ['Siti Aisyah'],
                akta_date: '2026-01-05', 
                akta_place: 'Virtual Meeting', 
                file_send_date: '2025-12-15', 
                notes: 'Perlu verifikasi data pemegang saham.',
                foto_akad_url: null,
                receipt_certificate_url: 'https://placehold.co/400x200/10b981/ffffff?text=RECEIPT+CERTIFICATE',
            },
        ];
        const MOCK_PERSONNEL = ["Rina Sari", "Budi Santoso", "Anya Wijaya", "Joko Pramono", "Siti Aisyah", "Deny Firmansyah"];
        const MOCK_JOB_GROUPS = ["Akta Tanah (PPAT)", "Akta Perusahaan (Notaris)", "Akta Waris & Hibah", "Legalisasi Dokumen", "Dokumen Keuangan & Pajak"];
        const MOCK_TYPE_SERVICE = ["Regular", "Priority"];

        // --- STATE MANAGEMENT ---
        let state = {
            currentPage: 'list', // 'list' or 'detail'
            modalOpen: false,
            selectedDivision: null, // ID of the division being viewed/edited
            activeDetailTab: 'ringkasan', // 'ringkasan', 'form-order', 'finance', 'data-pendukung'
        };

        // --- UTILITY FUNCTIONS ---
        function updateState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'N/A' || dateStr === 'TBC') return dateStr;
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatRupiah(number) {
             return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
        }
        
        // Function to create an SVG icon
        function getIcon(name, classes = 'w-5 h-5') {
            const icons = {
                'plus': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
                'edit': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>`,
                'trash': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
                'duplicate': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M13 3v2c0 1 1 2 2 2h2"/><path d="M16 17v-4c0-1-1-2-2-2h-4c-1 0-2 1-2 2v4"/></svg>`,
                'lock': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
                'cancel': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`,
                'detail': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                'back': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m15 18-6-6 6-6"/></svg>`,
                'upload': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`,
                'file': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`,
            };
            return icons[name] || '';
        }

        /**
         * Renders the List Job Divisi screen.
         */
        function renderList() {
            const listDiv = document.createElement('div');
            listDiv.className = 'bg-white shadow-xl rounded-xl p-4 md:p-8';

            const header = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                    <h1 class="text-3xl font-bold text-gray-800">Daftar Job Divisi</h1>
                    <button onclick="updateState({ modalOpen: true, selectedDivision: null })" class="mt-4 md:mt-0 px-6 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center transform hover:scale-[1.02]">
                        ${getIcon('plus', 'w-5 h-5 mr-2')}
                        Tambah Data
                    </button>
                </div>
            `;
            
            const tableBody = MOCK_DIVISIONS.map(div => `
                <tr class="border-b hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="updateState({ currentPage: 'detail', selectedDivision: ${div.id} })">
                    <td class="px-4 py-3 font-medium text-gray-900">${div.name}</td>
                    <td class="px-4 py-3">${div.division}</td>
                    <td class="px-4 py-3 hidden sm:table-cell">${div.group}</td>
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${div.status === 'Aktif' ? 'bg-secondary text-green-800' : div.status === 'Priority' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${div.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <button class="text-primary hover:text-indigo-700 p-2 rounded-full hover:bg-gray-100 transition duration-150" title="Lihat Detail">
                            ${getIcon('detail', 'w-5 h-5')}
                        </button>
                    </td>
                </tr>
            `).join('');

            const table = `
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Job Divisi</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Division</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Grup Pekerjaan</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableBody}
                        </tbody>
                    </table>
                </div>
            `;

            listDiv.innerHTML = header + table;
            return listDiv;
        }

        /**
         * Renders the Add/Edit Division Popup Form (Modal).
         * Disesuaikan dengan fields yang direvisi.
         */
        function renderPopupForm() {
            if (!state.modalOpen) return '';

            const isEdit = state.selectedDivision !== null;
            const currentDiv = isEdit ? MOCK_DIVISIONS.find(d => d.id === state.selectedDivision) : {};

            const divisionOptions = MOCK_PERSONNEL.map(p => `<option value="${p}" ${currentDiv.division === p ? 'selected' : ''}>${p}</option>`).join('');
            const groupOptions = MOCK_JOB_GROUPS.map(g => `<option value="${g}" ${currentDiv.group === g ? 'selected' : ''}>${g}</option>`).join('');
            const serviceOptions = MOCK_TYPE_SERVICE.map(t => `<option value="${t}" ${currentDiv.type_service === t ? 'selected' : ''}>${t}</option>`).join('');

            // Filter out already selected Perbantuan members for the dropdown (simplified for mock)
            const perbantuanOptions = MOCK_PERSONNEL
                .filter(p => !currentDiv.perbantuan?.includes(p))
                .map(p => `<option value="${p}">${p}</option>`).join('');
            
            // Display currently selected Perbantuan members
            const selectedPerbantuanTags = (currentDiv.perbantuan || []).map(p => `
                <span class="inline-flex items-center px-3 py-1 text-sm font-medium bg-indigo-100 text-indigo-800 rounded-full">
                    ${p}
                    <button type="button" class="ml-2 -mr-1 h-4 w-4 text-indigo-500 hover:text-indigo-700" onclick="alert('TODO: Remove ${p}')">${getIcon('cancel', 'w-3 h-3')}</button>
                </span>
            `).join('');

            return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <!-- Modal Header -->
                        <div class="px-6 py-4 border-b">
                            <h3 class="text-xl font-semibold text-gray-800">${isEdit ? 'Ubah Data Job Divisi' : 'Tambah Data Job Divisi Baru'}</h3>
                        </div>

                        <!-- Modal Body (Form) -->
                        <div class="p-6 space-y-5 custom-scroll max-h-[80vh] overflow-y-auto">
                            <!-- Field Nama Job Divisi Dihilangkan (Sesuai Permintaan) -->

                            <!-- Division (Pengganti Head of Division) -->
                            <div>
                                <label for="division" class="block text-sm font-medium text-gray-700 mb-1">Division <span class="text-red-500">*</span></label>
                                <select id="division" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                                    <option value="">Pilih Division</option>
                                    ${divisionOptions}
                                </select>
                            </div>

                            <!-- Grup Pekerjaan (sesuai flowchart) -->
                            <div>
                                <label for="grup_pekerjaan" class="block text-sm font-medium text-gray-700 mb-1">Grup Pekerjaan <span class="text-red-500">*</span></label>
                                <select id="grup_pekerjaan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                                    <option value="">Pilih Grup Pekerjaan</option>
                                    ${groupOptions}
                                </select>
                            </div>

                            <!-- Type of Service (New Dropdown) -->
                            <div>
                                <label for="type_service" class="block text-sm font-medium text-gray-700 mb-1">Type of Service <span class="text-red-500">*</span></label>
                                <select id="type_service" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                                    <option value="">Pilih Prioritas Layanan</option>
                                    ${serviceOptions}
                                </select>
                            </div>

                            <!-- Perbantuan (Sama seperti File responsible person) -->
                            <div>
                                <label for="perbantuan" class="block text-sm font-medium text-gray-700 mb-1">Perbantuan (Optional)</label>
                                <div class="space-y-2">
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        ${selectedPerbantuanTags}
                                    </div>
                                    <select id="perbantuan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white" onchange="alert('TODO: Add Perbantuan: ' + this.value)">
                                        <option value="">Tambah Anggota Perbantuan...</option>
                                        ${perbantuanOptions}
                                    </select>
                                </div>
                            </div>

                            <!-- Sub Form Konfigurasi (sesuai flowchart) -->
                            <div class="pt-4 border-t mt-4">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="config_now" class="form-checkbox text-primary rounded focus:ring-primary">
                                    <span class="ml-2 text-sm text-gray-700 font-medium">Lakukan Konfigurasi Data Pendukung seperti master</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Jika dicentang, akan langsung menuju halaman Detail setelah disimpan untuk melengkapi data master.</p>
                            </div>

                        </div>

                        <!-- Modal Footer -->
                        <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                            <button onclick="updateState({ modalOpen: false })" class="px-5 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition duration-150">
                                Cancel
                            </button>
                            <button onclick="saveDivision('${isEdit}')" class="px-5 py-2 bg-secondary text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                                Save / Simpan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Detail Job Divisi screen.
         */
        function renderDetail() {
            const division = MOCK_DIVISIONS.find(d => d.id === state.selectedDivision);
            if (!division) return document.createTextNode('');

            const detailDiv = document.createElement('div');
            detailDiv.className = 'space-y-6';

            // --- 1. Header and Action Buttons ---
            const actionButtons = `
                <div class="bg-white shadow-xl rounded-xl p-4 md:p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-4">
                        <div class="flex items-center space-x-3">
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 truncate">Detail Job Divisi: ${division.name}</h1>
                            <!-- Status dipindahkan ke Header -->
                            <span class="px-3 py-1 text-sm font-semibold rounded-full ${division.status === 'Aktif' ? 'bg-secondary text-green-800' : division.status === 'Priority' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                Status: ${division.status}
                            </span>
                        </div>
                        <button onclick="updateState({ currentPage: 'list', selectedDivision: null })" class="text-sm text-gray-600 hover:text-primary mt-3 md:mt-0 font-medium transition duration-150 flex items-center">
                            ${getIcon('back', 'w-4 h-4 mr-1')}
                            Kembali ke Daftar Job Divisi
                        </button>
                    </div>

                    <!-- Tombol Aksi - Action Buttons (Sesuai Flowchart) -->
                    <div class="flex flex-wrap gap-3">
                        <button onclick="updateState({ modalOpen: true })" class="flex items-center px-4 py-2 text-sm font-medium text-primary border border-primary rounded-lg hover:bg-primary hover:text-white transition duration-150">
                            ${getIcon('edit', 'w-4 h-4 mr-2')} Edit Data
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium text-red-600 border border-red-600 rounded-lg hover:bg-red-600 hover:text-white transition duration-150">
                            ${getIcon('trash', 'w-4 h-4 mr-2')} Hapus
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150">
                            ${getIcon('duplicate', 'w-4 h-4 mr-2')} Duplikat
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium text-yellow-600 border border-yellow-600 rounded-lg hover:bg-yellow-600 hover:text-white transition duration-150">
                            ${getIcon('lock', 'w-4 h-4 mr-2')} Freeze (Lock Data)
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium bg-red-500 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                            ${getIcon('cancel', 'w-4 h-4 mr-2')} Batal AKAD
                        </button>
                    </div>
                </div>
            `;
            detailDiv.innerHTML += actionButtons;

            // --- 2. Tabbed Interface ---
            const tabs = renderTabs(division);
            detailDiv.innerHTML += tabs;

            return detailDiv;
        }

        /**
         * Renders the content of the detail tabs.
         */
        function renderTabs(division) {
            const tabsNav = [
                { id: 'ringkasan', label: 'Tab Ringkasan' },
                { id: 'form-order', label: 'Tab Form Order' },
                { id: 'finance', label: 'Tab Finance' },
                { id: 'data-pendukung', label: 'Tab Supporting' }, // Label diperbarui
            ].map(tab => `
                <button
                    onclick="updateState({ activeDetailTab: '${tab.id}' })"
                    class="px-4 py-3 text-center border-b-2 text-sm md:text-base transition duration-150 whitespace-nowrap
                    ${state.activeDetailTab === tab.id ? 'tab-active border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                    ${tab.label}
                </button>
            `).join('');

            let tabContent = '';
            switch (state.activeDetailTab) {
                case 'ringkasan':
                    tabContent = renderTabRingkasan(division);
                    break;
                case 'form-order':
                    tabContent = renderTabFormOrder(division); 
                    break;
                case 'finance':
                    tabContent = renderTabFinance(division);
                    break;
                case 'data-pendukung':
                    tabContent = renderTabDataPendukung(division); 
                    break;
                default:
                    tabContent = 'Konten tidak ditemukan.';
            }

            return `
                <div class="bg-white shadow-xl rounded-xl p-0">
                    <div class="overflow-x-auto border-b">
                        <nav class="flex space-x-4 px-6 pt-3">
                            ${tabsNav}
                        </nav>
                    </div>
                    <div class="p-6">
                        ${tabContent}
                    </div>
                    <!-- Save/Cancel for Detail Tabs -->
                    <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 rounded-b-xl">
                        <button class="px-5 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition duration-150">
                            Cancel
                        </button>
                        <button class="px-5 py-2 bg-primary text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                            Save Data
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the fields for the Tab Ringkasan (Summary/Core Data).
         * Field disesuaikan dengan revisi terbaru.
         */
        function renderTabRingkasan(division) {
            const fields = [
                // (Label) Lock
                { label: 'Grup Pekerjaan (Lock)', value: division.group, type: 'text', readOnly: true, isLocked: true },
                
                // (Label)
                { label: 'Division', value: division.division, type: 'select', options: MOCK_PERSONNEL, placeholder: 'Division' }, // Division
                { label: 'Jenis Layanan', value: division.job_type, type: 'text', placeholder: 'Cth: Jual Beli, Hibah' },
                { label: 'Type of Service', value: division.type_service, type: 'select', options: MOCK_TYPE_SERVICE, placeholder: 'Regular / Priority' },
                { label: 'No. Registrasi Klien', value: division.registration_no, type: 'text', placeholder: 'Nomor referensi internal atau klien' },
                
                // (Label) Perbantuan
                { label: 'Penanggung Jawab Berkas', value: division.person_in_charge, type: 'select', options: MOCK_PERSONNEL, placeholder: 'PIC' },
                { label: 'Perbantuan', value: division.perbantuan.join(', '), type: 'text', readOnly: true, placeholder: 'Daftar anggota perbantuan' },
                
                // (Label)
                { label: 'Tanggal & Tempat AKAD', value: division.akta_date, type: 'date', value2: division.akta_place, type2: 'text' }, // Combined field
                { label: 'Tanggal Kirim Berkas', value: division.file_send_date, type: 'date' },
                { label: 'Tanggal Estimasi Berkas Selesai', value: division.estimate, type: 'date' },
            ];

            // Render single field or combined field (for Tanggal & Tempat AKAD)
            const formFields = fields.map(field => {
                const baseId = field.label.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_{2,}/g, '_');
                const isLocked = field.isLocked || field.readOnly;

                if (field.label.includes('Tanggal & Tempat AKAD')) {
                    // Combined field: Tanggal dan Tempat AKAD
                    return `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-1 md:col-span-2">
                            <div>
                                <label for="${baseId}_date" class="block text-sm font-medium text-gray-700 mb-1">${field.label} - Tanggal</label>
                                <input type="date" id="${baseId}_date" value="${field.value}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="${baseId}_place" class="block text-sm font-medium text-gray-700 mb-1">${field.label} - Tempat</label>
                                <input type="${field.type2}" id="${baseId}_place" value="${field.value2}" placeholder="Cth: Kantor Notaris Utama" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-primary focus:border-primary">
                            </div>
                        </div>
                    `;
                }

                let inputHtml;
                const inputClasses = "w-full px-4 py-2 border rounded-lg";
                const focusClasses = isLocked ? 'field-locked' : 'bg-white focus:ring-primary focus:border-primary';
                
                if (field.type === 'select') {
                    const optionsHtml = field.options.map(opt => `<option value="${opt}" ${opt === field.value || (Array.isArray(field.value) && field.value.includes(opt)) ? 'selected' : ''}>${opt}</option>`).join('');
                    inputHtml = `<select id="${baseId}" class="${inputClasses} ${focusClasses} bg-white" ${isLocked ? 'disabled' : ''} ${field.placeholder ? '' : ''}>
                                    <option value="" disabled ${!field.value ? 'selected' : ''}>${field.placeholder || 'Pilih...'}</option>
                                    ${optionsHtml}
                                 </select>`;
                } else if (field.type === 'date') {
                    inputHtml = `<input type="date" id="${baseId}" value="${field.value}" class="${inputClasses} ${focusClasses}" ${isLocked ? 'readonly' : ''}>`;
                } else {
                    const placeholderAttr = field.placeholder ? `placeholder="${field.placeholder}"` : '';
                    inputHtml = `<input type="text" id="${baseId}" value="${field.value}" ${placeholderAttr} class="${inputClasses} ${focusClasses}" ${isLocked ? 'readonly' : ''}>`;
                }

                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                        ${inputHtml}
                    </div>
                `;
            }).join('');

            // Bagian Upload & Preview (Menggantikan Description)
            const uploadSection = (label, id, url) => {
                const hasFile = !!url;
                return `
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">${label}</label>
                        <div class="relative">
                            <input type="file" id="${id}" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewUpload(event, '${id}')">
                            <div id="preview_${id}" class="preview-container ${hasFile ? 'has-file' : ''}">
                                ${hasFile ? `
                                    <img src="${url}" onerror="this.outerHTML='<span class=\\'text-sm text-center\\'>Preview gagal. Klik untuk upload ulang.</span>'" class="max-h-32 max-w-full rounded-lg object-contain mb-2">
                                    <span class="text-xs text-green-700 font-medium">File Terupload. Klik untuk Ganti.</span>
                                ` : `
                                    ${getIcon('upload', 'w-6 h-6 text-gray-400 mb-1')}
                                    <span class="text-sm text-center">Klik atau Seret file ${label}</span>
                                    <span class="text-xs text-gray-400 mt-1">PDF/JPG Maks. 5MB</span>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            };

            const fotoAkadUpload = uploadSection('Upload Foto AKAD (dan Preview Hasilnya)', 'upload_foto_akad', division.foto_akad_url);
            const receiptCertUpload = uploadSection('Upload Receipt Certificate', 'upload_receipt_certificate', division.receipt_certificate_url);

            return `
                <form class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    ${formFields}
                    ${fotoAkadUpload}
                    ${receiptCertUpload}
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Catatan Tambahan (Ringkasan)</label>
                        <textarea rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white">${division.notes}</textarea>
                    </div>
                </form>
            `;
        }
        
        /**
         * Renders the Tab Form Order (Itemization).
         * Header action dihilangkan, hanya menyisakan tombol tong sampah di detail kolom.
         * Detail kolom diubah (disesuaikan dengan skema entry data).
         */
        function renderTabFormOrder(division) {
            const jobItems = [
                { id: 1, type: "Item Akta", description: "Drafting Akta Jual Beli", status: "Final", pic: "Rina Sari" },
                { id: 2, type: "Item Dukungan", description: "Pengurusan SKPT", status: "Reviewed", pic: "Anya Wijaya" },
                { id: 3, type: "Item Dokumen", description: "Pengecekan Sertifikat BPN", status: "Done", pic: "Joko Pramono" },
            ];

            const itemRows = jobItems.map(item => `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="px-4 py-3">${item.type}</td>
                    <td class="px-4 py-3">${item.description}</td>
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${item.status === 'Final' ? 'bg-secondary text-green-800' : item.status === 'Reviewed' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 hidden sm:table-cell">${item.pic}</td>
                    <td class="px-4 py-3 text-right w-16">
                        <!-- Hanya tombol Hapus/Tong Sampah yang tersisa -->
                        <button class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-gray-100 transition duration-150" title="Hapus Item">${getIcon('trash', 'w-4 h-4')}</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h4 class="text-xl font-semibold text-gray-700">Item Pekerjaan Akta (${division.name})</h4>
                        <button class="px-4 py-2 bg-primary text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center text-sm">
                            ${getIcon('plus', 'w-4 h-4 mr-2')} Tambah Item Baru
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi Pekerjaan</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proses Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">PIC</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${itemRows}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm font-medium text-primary border-t pt-3">
                        Tabel Ringkasan: Total ${jobItems.length} item pekerjaan terdaftar untuk Job Divisi ini.
                    </p>
                </div>
            `;
        }

        /**
         * Renders the Tab Finance (Cost Logging and Summary).
         * Detail Kolom disesuaikan.
         */
        function renderTabFinance(division) {
            const costItems = [
                { id: 1, name: "Fee Notaris/PPAT (Honorarium)", type: "Pemasukan", amount: 5000000, date: '2025-10-30', notes: 'Pembayaran Fee Klien' },
                { id: 2, name: "Biaya Pengecekan BPN", type: "Pengeluaran", amount: 500000, date: '2025-10-05', notes: 'Biaya ke Notaris Mitra' },
                { id: 3, name: "Biaya Administrasi Bank", type: "Pengeluaran", amount: 150000, date: '2025-10-01', notes: 'Transfer Bank' },
            ];
            
            const totalIncome = costItems.filter(item => item.type === 'Pemasukan').reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = costItems.filter(item => item.type === 'Pengeluaran').reduce((sum, item) => sum + item.amount, 0);
            const netTotal = totalIncome - totalExpense;

            const costRows = costItems.map(item => `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="px-4 py-3 text-sm">${formatDate(item.date)}</td>
                    <td class="px-4 py-3 text-sm font-medium">
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${item.type === 'Pemasukan' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${item.type}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${item.name}</td>
                    <td class="px-4 py-3 text-sm hidden sm:table-cell">${item.notes}</td>
                    <td class="px-4 py-3 text-sm font-bold ${item.type === 'Pemasukan' ? 'text-secondary' : 'text-red-500'}">${formatRupiah(item.amount)}</td>
                    <td class="px-4 py-3 text-right w-16">
                        <button class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-gray-100 transition duration-150" title="Hapus Biaya">${getIcon('trash', 'w-4 h-4')}</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <h4 class="text-xl font-semibold text-gray-700 border-b pb-3">Ringkasan Keuangan Job Divisi</h4>

                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-indigo-50 p-5 rounded-xl shadow-md border-l-4 border-primary">
                            <p class="text-sm font-medium text-gray-500">Total Pemasukan</p>
                            <p class="text-2xl font-bold text-primary mt-1">${formatRupiah(totalIncome)}</p>
                        </div>
                        <div class="bg-red-50 p-5 rounded-xl shadow-md border-l-4 border-red-500">
                            <p class="text-sm font-medium text-gray-500">Total Pengeluaran</p>
                            <p class="text-2xl font-bold text-red-600 mt-1">${formatRupiah(totalExpense)}</p>
                        </div>
                        <div class="bg-secondary/10 p-5 rounded-xl shadow-md border-l-4 border-secondary">
                            <p class="text-sm font-medium text-gray-500">Total Bersih</p>
                            <p class="text-2xl font-bold text-secondary mt-1">${formatRupiah(netTotal)}</p>
                        </div>
                    </div>

                    <!-- Cost Logging Section -->
                    <div class="pt-4 border-t">
                        <div class="flex justify-between items-center pb-3">
                            <h5 class="text-lg font-semibold text-gray-700">Detail Pencatatan Transaksi Keuangan</h5>
                            <button class="px-4 py-2 border border-secondary text-secondary font-medium rounded-lg hover:bg-secondary hover:text-white transition duration-150 flex items-center text-sm">
                                ${getIcon('plus', 'w-4 h-4 mr-2')} Catat Transaksi Baru
                            </button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi Item</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Keterangan</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nominal</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${costRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }


        /**
         * Renders the Tab Supporting (Entry Field).
         * Disiapkan untuk field yang bisa di-entry user (diasumsikan sebagai field kustom).
         */
        function renderTabDataPendukung(division) {
            // Mock data for editable supporting fields
            const supportingData = {
                title: 'Data Pendukung Kustom',
                fields: [
                    { label: 'No. Sertifikat Hak Milik', value: '11.01.03.0001.00234', placeholder: 'Nomor Sertifikat' },
                    { label: 'Luas Tanah (M2)', value: '150', placeholder: 'Hanya angka' },
                    { label: 'Nilai Transaksi (IDR)', value: '1,500,000,000', placeholder: 'Nilai Jual Beli' },
                    { label: 'Keterangan Tambahan PPAT', value: 'Aset bebas sengketa, PBB lunas 2024.', type: 'textarea', rows: 3 },
                ]
            };
            
            const formFields = supportingData.fields.map((field, index) => {
                const baseId = `support_${index}`;
                
                let inputHtml;
                const inputClasses = "w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-primary focus:border-primary transition duration-150";

                if (field.type === 'textarea') {
                    inputHtml = `<textarea id="${baseId}" rows="${field.rows}" placeholder="${field.placeholder}" class="${inputClasses}">${field.value}</textarea>`;
                } else {
                    inputHtml = `<input type="text" id="${baseId}" value="${field.value}" placeholder="${field.placeholder}" class="${inputClasses}">`;
                }

                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                        ${inputHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Entry Data Pendukung (Data Master Klien & Properti)</h4>
                        
                        <form class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            ${formFields}
                        </form>

                        <p class="text-xs text-gray-500 mt-6">Data ini akan digunakan sebagai referensi untuk drafting akta.</p>
                    </div>

                    <!-- Master Data Link Section (Opsional, tetap dipertahankan) -->
                    <div class="bg-indigo-50 p-5 rounded-xl shadow-inner border border-indigo-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Integrasi ke Master Data Bank</h4>
                        <p class="text-sm text-gray-600 mb-4">Pastikan data pihak dan aset sudah terdaftar dan terintegrasi di modul Master Data Bank.</p>
                        <div class="flex flex-wrap gap-4">
                            <button class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 text-sm shadow-md">
                                Buka Master Data Pihak Klien
                            </button>
                            <button class="px-4 py-2 border border-primary text-primary font-medium rounded-lg hover:bg-indigo-50 text-sm">
                                Buka Master Data Properti/Aset
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- ACTION HANDLERS ---

        /**
         * Simple function to mock the file upload preview (only client-side).
         */
        function previewUpload(event, id) {
            const file = event.target.files[0];
            const previewElement = document.getElementById(`preview_${id}`);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Simple preview for image/pdf (using image for simplicity)
                    const isImage = file.type.startsWith('image/');
                    const fileContent = isImage ? `<img src="${e.target.result}" class="max-h-32 max-w-full rounded-lg object-contain mb-2">` : getIcon('file', 'w-8 h-8 text-green-600 mb-1') + `<span class="text-sm font-medium">${file.name}</span>`;

                    previewElement.classList.add('has-file');
                    previewElement.innerHTML = `
                        ${fileContent}
                        <span class="text-xs text-green-700 font-medium mt-1">File Terupload. Klik untuk Ganti.</span>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                previewElement.classList.remove('has-file');
                previewElement.innerHTML = `
                    ${getIcon('upload', 'w-6 h-6 text-gray-400 mb-1')}
                    <span class="text-sm text-center">Klik atau Seret file</span>
                    <span class="text-xs text-gray-400 mt-1">PDF/JPG Maks. 5MB</span>
                `;
            }
        }


        function saveDivision(isEdit) {
            const divisionName = document.getElementById('division').value;
            const group = document.getElementById('grup_pekerjaan').value;
            const typeService = document.getElementById('type_service').value;
            const configNow = document.getElementById('config_now').checked;

            if (!divisionName || !group || !typeService) {
                console.error('Validation Error: Field Division, Grup Pekerjaan, dan Type of Service harus diisi.');
                // In a real app, use a custom modal
                return;
            }

            console.log(`${isEdit === 'true' ? 'Updating' : 'Creating'} division:`, { divisionName, group, typeService, configNow });

            // Mock Data Update/Create Logic
            if (isEdit === 'true') {
                // ... logic to save changes to state.selectedDivision
            } else {
                // Add new division to MOCK_DIVISIONS (Mocking new ID)
                const newId = MOCK_DIVISIONS.length + 1;
                MOCK_DIVISIONS.push({
                    id: newId,
                    name: "Job Baru - " + group,
                    division: divisionName,
                    group: group,
                    status: 'Aktif',
                    type_service: typeService,
                    estimate: 'TBC',
                    job_type: '',
                    registration_no: '',
                    person_in_charge: divisionName,
                    perbantuan: [],
                    akta_date: '',
                    akta_place: '',
                    file_send_date: '',
                    notes: '',
                    foto_akad_url: null,
                    receipt_certificate_url: null,
                });
            }

            // Redirect based on 'configNow' checkbox
            updateState({ 
                modalOpen: false, 
                currentPage: configNow ? 'detail' : 'list',
                selectedDivision: configNow ? MOCK_DIVISIONS[MOCK_DIVISIONS.length - 1].id : null
            });
        }


        // --- MAIN RENDER FUNCTION ---

        function renderApp() {
            const appContainer = document.getElementById('app');
            const modalContainer = document.getElementById('modal-container');
            
            // Clear containers
            appContainer.innerHTML = '';
            modalContainer.innerHTML = '';

            // Render main page content
            let content;
            if (state.currentPage === 'list') {
                content = renderList();
            } else if (state.currentPage === 'detail') {
                content = renderDetail();
            }
            appContainer.appendChild(content);

            // Render modal if open
            modalContainer.innerHTML = renderPopupForm();
        }

        // Initialize the application
        window.onload = renderApp;
    </script>

</body>
</html>
