<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Divisi Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'background-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for professional look and scrollability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3ff6;
        }
        /* Style for the active tab indicator */
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        /* Style for Locked ReadOnly Fields */
        .field-locked {
            @apply bg-gray-100 border-gray-200 text-gray-500 font-medium;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="p-4 md:p-8">
        <!-- Application content will be rendered here -->
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        // --- MOCK DATA (DISESUAIKAN UNTUK NOTARIS & PPAT) ---
        const MOCK_DIVISIONS = [
            // estimate date format: YYYY-MM-DD
            { id: 1, name: "AJB Properti A", head: "Rina Sari", group: "Akta Tanah (PPAT)", status: "Aktif", estimate: "2025-12-15", job_type: 'Jual Beli', registration_no: 'R/2025/112/A', person_in_charge: 'Joko Pramono', akta_date: '2025-10-30', akta_place: 'Kantor Notaris Utama', file_send_date: '2025-10-10', notes: 'Masukkan catatan penting terkait proses akta atau berkas di sini...' },
            { id: 2, name: "Pendirian PT Mega Karya", head: "Budi Santoso", group: "Akta Perusahaan (Notaris)", status: "Frozen", estimate: "2026-01-01", job_type: 'Pendirian PT', registration_no: 'R/2025/113/B', person_in_charge: 'Anya Wijaya', akta_date: '2026-01-05', akta_place: 'Virtual Meeting', file_send_date: '2025-12-15', notes: 'Perlu verifikasi data pemegang saham.' },
        ];
        const MOCK_PERSONNEL = ["Rina Sari", "Budi Santoso", "Anya Wijaya", "Joko Pramono", "Siti Aisyah", "Deny Firmansyah"];
        const MOCK_JOB_GROUPS = ["Akta Tanah (PPAT)", "Akta Perusahaan (Notaris)", "Akta Waris & Hibah", "Legalisasi Dokumen", "Dokumen Keuangan & Pajak"];

        // --- STATE MANAGEMENT ---
        let state = {
            currentPage: 'list', // 'list' or 'detail'
            modalOpen: false,
            selectedDivision: null, // ID of the division being viewed/edited
            activeDetailTab: 'ringkasan', // 'ringkasan', 'form-order', 'finance', 'data-pendukung'
        };

        // --- UTILITY FUNCTIONS ---

        /**
         * Simple function to safely update the state and re-render the application.
         * @param {object} newState - Partial state object to merge.
         */
        function updateState(newState) {
            state = { ...state, ...newState };
            renderApp();
        }

        /**
         * Converts date string to readable Indonesian format.
         */
        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'N/A' || dateStr === 'TBC') return dateStr;
            const date = new Date(dateStr);
            // Check if date is valid
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        /**
         * Formats number to Rupiah currency.
         */
        function formatRupiah(number) {
             return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
        }
        
        // Function to create an SVG icon
        function getIcon(name, classes = 'w-5 h-5') {
            const icons = {
                'plus': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
                'edit': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>`,
                'trash': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`,
                'duplicate': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M13 3v2c0 1 1 2 2 2h2"/><path d="M16 17v-4c0-1-1-2-2-2h-4c-1 0-2 1-2 2v4"/></svg>`,
                'lock': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
                'cancel': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`,
                'detail': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                'back': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m15 18-6-6 6-6"/></svg>`,
            };
            return icons[name] || '';
        }

        // --- UI COMPONENTS ---

        /**
         * Renders the List Job Divisi screen.
         */
        function renderList() {
            const listDiv = document.createElement('div');
            listDiv.className = 'bg-white shadow-xl rounded-xl p-4 md:p-8';

            const header = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                    <h1 class="text-3xl font-bold text-gray-800">Daftar Job Divisi</h1>
                    <button onclick="updateState({ modalOpen: true, selectedDivision: null })" class="mt-4 md:mt-0 px-6 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center transform hover:scale-[1.02]">
                        ${getIcon('plus', 'w-5 h-5 mr-2')}
                        Tambah Data
                    </button>
                </div>
            `;
            
            const tableBody = MOCK_DIVISIONS.map(div => `
                <tr class="border-b hover:bg-gray-50 transition duration-150 cursor-pointer" onclick="updateState({ currentPage: 'detail', selectedDivision: ${div.id} })">
                    <td class="px-4 py-3 font-medium text-gray-900">${div.name}</td>
                    <td class="px-4 py-3">${div.head}</td>
                    <td class="px-4 py-3 hidden sm:table-cell">${div.group}</td>
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${div.status === 'Aktif' ? 'bg-secondary text-green-800' : div.status === 'Frozen' ? 'bg-yellow-100 text-yellow-800' : div.status.includes('Selesai') ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                            ${div.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        <button class="text-primary hover:text-indigo-700 p-2 rounded-full hover:bg-gray-100 transition duration-150" title="Lihat Detail">
                            ${getIcon('detail', 'w-5 h-5')}
                        </button>
                    </td>
                </tr>
            `).join('');

            const table = `
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Divisi</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kepala Divisi</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Grup Pekerjaan</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableBody}
                        </tbody>
                    </table>
                </div>
            `;

            listDiv.innerHTML = header + table;
            return listDiv;
        }

        /**
         * Renders the Add/Edit Division Popup Form (Modal).
         * Disesuaikan dengan fields dari flowchart: Nama Job Divisi, Kepala Divisi, Grup Pekerjaan, dan Sub Form Konfigurasi.
         */
        function renderPopupForm() {
            if (!state.modalOpen) return '';

            const isEdit = state.selectedDivision !== null;
            const currentDiv = isEdit ? MOCK_DIVISIONS.find(d => d.id === state.selectedDivision) : {};

            const personnelOptions = MOCK_PERSONNEL.map(p => `<option value="${p}" ${currentDiv.head === p ? 'selected' : ''}>${p}</option>`).join('');
            const groupOptions = MOCK_JOB_GROUPS.map(g => `<option value="${g}" ${currentDiv.group === g ? 'selected' : ''}>${g}</option>`).join('');

            return `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100">
                        <!-- Modal Header -->
                        <div class="px-6 py-4 border-b">
                            <h3 class="text-xl font-semibold text-gray-800">${isEdit ? 'Ubah Data Job Divisi' : 'Tambah Data Job Divisi Baru'}</h3>
                        </div>

                        <!-- Modal Body (Form) -->
                        <div class="p-6 space-y-5 custom-scroll max-h-[80vh] overflow-y-auto">
                            <!-- Nama Job Divisi (sesuai flowchart) -->
                            <div>
                                <label for="nama_divisi" class="block text-sm font-medium text-gray-700 mb-1">Nama Job Divisi <span class="text-red-500">*</span></label>
                                <input type="text" id="nama_divisi" value="${currentDiv.name || ''}" placeholder="Cth: AJB Properti A" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                            </div>

                            <!-- Kepala Divisi (sesuai flowchart) -->
                            <div>
                                <label for="kepala_divisi" class="block text-sm font-medium text-gray-700 mb-1">Kepala Divisi <span class="text-red-500">*</span></label>
                                <select id="kepala_divisi" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                                    <option value="">Pilih Kepala Divisi</option>
                                    ${personnelOptions}
                                </select>
                            </div>

                            <!-- Grup Pekerjaan (sesuai flowchart) -->
                            <div>
                                <label for="grup_pekerjaan" class="block text-sm font-medium text-gray-700 mb-1">Grup Pekerjaan <span class="text-red-500">*</span></label>
                                <select id="grup_pekerjaan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                                    <option value="">Pilih Grup Pekerjaan (Contoh: Akta Tanah)</option>
                                    ${groupOptions}
                                </select>
                            </div>

                            <!-- Sub Form Konfigurasi (sesuai flowchart) -->
                            <div class="pt-4 border-t mt-4">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="config_now" class="form-checkbox text-primary rounded focus:ring-primary">
                                    <span class="ml-2 text-sm text-gray-700 font-medium">Lakukan Konfigurasi Data Pendukung seperti master</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Jika dicentang, akan langsung menuju halaman Detail setelah disimpan untuk melengkapi data master.</p>
                            </div>

                        </div>

                        <!-- Modal Footer -->
                        <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                            <button onclick="updateState({ modalOpen: false })" class="px-5 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition duration-150">
                                Cancel
                            </button>
                            <button onclick="saveDivision('${isEdit}')" class="px-5 py-2 bg-secondary text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition duration-150">
                                Save / Simpan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Detail Job Divisi screen.
         */
        function renderDetail() {
            const division = MOCK_DIVISIONS.find(d => d.id === state.selectedDivision);
            if (!division) return document.createTextNode('');

            const detailDiv = document.createElement('div');
            detailDiv.className = 'space-y-6';

            // --- 1. Header and Action Buttons ---
            const actionButtons = `
                <div class="bg-white shadow-xl rounded-xl p-4 md:p-6 mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-4">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 truncate">Detail Job Divisi: ${division.name}</h1>
                        <button onclick="updateState({ currentPage: 'list', selectedDivision: null })" class="text-sm text-gray-600 hover:text-primary mt-3 md:mt-0 font-medium transition duration-150 flex items-center">
                            ${getIcon('back', 'w-4 h-4 mr-1')}
                            Kembali ke Daftar Job Divisi
                        </button>
                    </div>

                    <!-- Tombol Aksi - Action Buttons (Sesuai Flowchart) -->
                    <div class="flex flex-wrap gap-3">
                        <button onclick="updateState({ modalOpen: true })" class="flex items-center px-4 py-2 text-sm font-medium text-primary border border-primary rounded-lg hover:bg-primary hover:text-white transition duration-150">
                            ${getIcon('edit', 'w-4 h-4 mr-2')} Edit
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium text-red-600 border border-red-600 rounded-lg hover:bg-red-600 hover:text-white transition duration-150">
                            ${getIcon('trash', 'w-4 h-4 mr-2')} Hapus
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-100 transition duration-150">
                            ${getIcon('duplicate', 'w-4 h-4 mr-2')} Duplikat
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium text-yellow-600 border border-yellow-600 rounded-lg hover:bg-yellow-600 hover:text-white transition duration-150">
                            ${getIcon('lock', 'w-4 h-4 mr-2')} Freeze (Lock Data)
                        </button>
                        <button class="flex items-center px-4 py-2 text-sm font-medium bg-red-500 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-150">
                            ${getIcon('cancel', 'w-4 h-4 mr-2')} Batal AKAD
                        </button>
                    </div>
                </div>
            `;
            detailDiv.innerHTML += actionButtons;

            // --- 2. Tabbed Interface ---
            const tabs = renderTabs(division);
            detailDiv.innerHTML += tabs;

            return detailDiv;
        }

        /**
         * Renders the content of the detail tabs.
         */
        function renderTabs(division) {
            // Label Tab disesuaikan dengan permintaan user (menghilangkan 'chart sebelum detail')
            const tabsNav = [
                { id: 'ringkasan', label: 'Tab Ringkasan' },
                { id: 'form-order', label: 'Tab Form Order' },
                { id: 'finance', label: 'Tab Finance' },
                { id: 'data-pendukung', label: 'Tab Data Pendukung' },
            ].map(tab => `
                <button
                    onclick="updateState({ activeDetailTab: '${tab.id}' })"
                    class="px-4 py-3 text-center border-b-2 text-sm md:text-base transition duration-150 whitespace-nowrap
                    ${state.activeDetailTab === tab.id ? 'tab-active border-primary text-primary' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                    ${tab.label}
                </button>
            `).join('');

            let tabContent = '';
            switch (state.activeDetailTab) {
                case 'ringkasan':
                    tabContent = renderTabRingkasan(division);
                    break;
                case 'form-order':
                    tabContent = renderTabFormOrder(division); 
                    break;
                case 'finance':
                    tabContent = renderTabFinance(division);
                    break;
                case 'data-pendukung':
                    tabContent = renderTabDataPendukung(division); 
                    break;
                default:
                    tabContent = 'Konten tidak ditemukan.';
            }

            return `
                <div class="bg-white shadow-xl rounded-xl p-0">
                    <div class="overflow-x-auto border-b">
                        <nav class="flex space-x-4 px-6 pt-3">
                            ${tabsNav}
                        </nav>
                    </div>
                    <div class="p-6">
                        ${tabContent}
                    </div>
                    <!-- Save/Cancel for Detail Tabs -->
                    <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 rounded-b-xl">
                        <button class="px-5 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition duration-150">
                            Cancel
                        </button>
                        <button class="px-5 py-2 bg-primary text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                            Save Data
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the fields for the Tab Ringkasan (Summary/Core Data).
         * Field disesuaikan dengan flowchart, dan formatnya diubah menjadi 1 row per data.
         * Note: Field yang berlabel (Lock) dibuat readOnly dengan styling field-locked.
         */
        function renderTabRingkasan(division) {
            // Data fields sesuai urutan di Flowchart "Detail Tab Ringkasan"
            const fields = [
                // (Label) Lock
                { label: 'Nama Job Divisi (Lock)', value: division.name, type: 'text', readOnly: true, isLocked: true },
                { label: 'Grup Pekerjaan (Lock)', value: division.group, type: 'text', readOnly: true, isLocked: true },
                
                // (Label)
                { label: 'Jenis Layanan', value: division.job_type, type: 'text', placeholder: 'Cth: Pendirian PT, Jual Beli, Hibah' },
                { label: 'No. Registrasi Klien', value: division.registration_no, type: 'text', placeholder: 'Nomor referensi internal atau klien' },
                { label: 'Kepala Divisi', value: division.head, type: 'select', options: MOCK_PERSONNEL },
                { label: 'Penanggung Jawab Berkas', value: division.person_in_charge, type: 'select', options: MOCK_PERSONNEL },
                
                // (Label) Lock
                { label: 'Status (Lock)', value: division.status, type: 'text', readOnly: true, isLocked: true },
                
                // (Label)
                { label: 'Tanggal & Tempat AKAD (Calendar Picker)', value: division.akta_date, type: 'datetime-local', value2: division.akta_place, type2: 'text' }, // Combined field
                { label: 'Tanggal Kirim Berkas', value: division.file_send_date, type: 'date' },
                { label: 'Tanggal Estimasi Berkas Selesai', value: division.estimate, type: 'date' },
            ];

            // Render single field or combined field (for Tanggal & Tempat AKAD)
            const formFields = fields.map(field => {
                const baseId = field.label.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_{2,}/g, '_');
                const isLocked = field.isLocked;

                if (field.label.includes('Tanggal & Tempat AKAD')) {
                    // Combined field: Tanggal dan Tempat AKAD
                    return `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 col-span-1 md:col-span-2">
                            <div>
                                <label for="${baseId}_date" class="block text-sm font-medium text-gray-700 mb-1">${field.label.replace('(Calendar Picker)', '')} - Tanggal</label>
                                <input type="date" id="${baseId}_date" value="${field.value}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label for="${baseId}_place" class="block text-sm font-medium text-gray-700 mb-1">${field.label.replace('(Calendar Picker)', '')} - Tempat</label>
                                <input type="${field.type2}" id="${baseId}_place" value="${field.value2}" placeholder="Cth: Kantor Notaris Utama" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-primary focus:border-primary">
                            </div>
                        </div>
                    `;
                }

                let inputHtml;
                const inputClasses = "w-full px-4 py-2 border rounded-lg";
                const focusClasses = isLocked ? 'field-locked' : 'bg-white focus:ring-primary focus:border-primary';
                
                if (field.type === 'select') {
                    const optionsHtml = field.options.map(opt => `<option value="${opt}" ${opt === field.value ? 'selected' : ''}>${opt}</option>`).join('');
                    inputHtml = `<select id="${baseId}" class="${inputClasses} ${focusClasses} bg-white" ${isLocked ? 'disabled' : ''}>${optionsHtml}</select>`;
                } else if (field.type === 'date') {
                    inputHtml = `<input type="date" id="${baseId}" value="${field.value}" class="${inputClasses} ${focusClasses}" ${isLocked ? 'readonly' : ''}>`;
                } else {
                    const placeholderAttr = field.placeholder ? `placeholder="${field.placeholder}"` : '';
                    inputHtml = `<input type="text" id="${baseId}" value="${field.value}" ${placeholderAttr} class="${inputClasses} ${focusClasses}" ${isLocked ? 'readonly' : ''}>`;
                }

                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                        ${inputHtml}
                    </div>
                `;
            }).join('');

            // Bagian Text Area dan Upload disesuaikan dengan Flowchart
            const notesAndUploadSection = `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Text Area)</label>
                    <textarea rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary bg-white">${division.notes}</textarea>
                </div>
                <div class="md:col-span-2 space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Upload tanda terima berkas (2 slot upload...)</label>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-primary transition duration-150 cursor-pointer">
                            <input type="file" id="upload_slot_1" class="hidden">
                            <label for="upload_slot_1" class="text-sm text-gray-500 block">Slot 1: Klik untuk upload atau seret file</label>
                            <span class="text-xs text-primary mt-1 block">Maks. 5MB, format PDF/JPG</span>
                        </div>
                        <div class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-primary transition duration-150 cursor-pointer">
                            <input type="file" id="upload_slot_2" class="hidden">
                            <label for="upload_slot_2" class="text-sm text-gray-500 block">Slot 2: Klik untuk upload atau seret file</label>
                            <span class="text-xs text-primary mt-1 block">Maks. 5MB, format PDF/JPG</span>
                        </div>
                    </div>
                </div>
            `;

            return `
                <form class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    ${formFields}
                    ${notesAndUploadSection}
                </form>
            `;
        }
        
        /**
         * Renders the Tab Form Order (Itemization).
         */
        function renderTabFormOrder(division) {
            const jobItems = [
                { id: 1, name: "Drafting Akta Jual Beli (AJB)", qty: 1, status: "Final", responsible: "Rina Sari" },
                { id: 2, name: "Pengurusan SKPT", qty: 1, status: "Reviewed", responsible: "Anya Wijaya" },
                { id: 3, name: "Pengecekan Sertifikat BPN", qty: 1, status: "Done", responsible: "Joko Pramono" },
            ];

            const itemRows = jobItems.map(item => `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="px-4 py-3">${item.name}</td>
                    <td class="px-4 py-3 w-20 text-center">${item.qty}</td>
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full ${item.status === 'Final' ? 'bg-secondary text-green-800' : item.status === 'Reviewed' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 hidden sm:table-cell">${item.responsible}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="text-primary hover:text-indigo-700 p-1 rounded-full hover:bg-gray-100 transition duration-150" title="Edit Item">${getIcon('edit', 'w-4 h-4')}</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h4 class="text-xl font-semibold text-gray-700">Item Pekerjaan Akta (${division.name})</h4>
                        <button class="px-4 py-2 bg-primary text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 flex items-center text-sm">
                            ${getIcon('plus', 'w-4 h-4 mr-2')} Tambah Item
                        </button>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proses Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">PIC</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${itemRows}
                            </tbody>
                        </table>
                    </div>
                    <!-- Penggantian Diksi: Keterangan diangkut -> Tabel Ringkasan (sesuai permintaan user) -->
                    <p class="text-sm font-medium text-primary border-t pt-3">
                        Tabel Ringkasan: Total 3 item pekerjaan terdaftar untuk Job Divisi ini.
                    </p>
                </div>
            `;
        }

        /**
         * Renders the Tab Finance (Cost Logging and Summary).
         */
        function renderTabFinance(division) {
            const costItems = [
                { id: 1, name: "Fee Notaris/PPAT (Honorarium)", amount: 5000000, type: "Income" },
                { id: 2, name: "Biaya Pengecekan BPN", amount: 500000, type: "Expense" },
                { id: 3, name: "Biaya Administrasi Bank", amount: 150000, type: "Expense" },
            ];
            
            const totalIncome = costItems.filter(item => item.type === 'Income').reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = costItems.filter(item => item.type === 'Expense').reduce((sum, item) => sum + item.amount, 0);
            const netTotal = totalIncome - totalExpense;

            const costRows = costItems.map(item => `
                <tr class="border-b hover:bg-gray-50 transition duration-150">
                    <td class="px-4 py-3 text-sm">${item.name}</td>
                    <td class="px-4 py-3 text-sm font-medium ${item.type === 'Income' ? 'text-secondary' : 'text-red-500'}">${formatRupiah(item.amount)}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-gray-100 transition duration-150" title="Hapus Biaya">${getIcon('trash', 'w-4 h-4')}</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <h4 class="text-xl font-semibold text-gray-700 border-b pb-3">Ringkasan Keuangan Job Divisi</h4>

                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-indigo-50 p-5 rounded-xl shadow-md border-l-4 border-primary">
                            <p class="text-sm font-medium text-gray-500">Total Pemasukan (Fee)</p>
                            <p class="text-2xl font-bold text-primary mt-1">${formatRupiah(totalIncome)}</p>
                        </div>
                        <div class="bg-red-50 p-5 rounded-xl shadow-md border-l-4 border-red-500">
                            <p class="text-sm font-medium text-gray-500">Total Pengeluaran (Biaya)</p>
                            <p class="text-2xl font-bold text-red-600 mt-1">${formatRupiah(totalExpense)}</p>
                        </div>
                        <div class="bg-secondary/10 p-5 rounded-xl shadow-md border-l-4 border-secondary">
                            <p class="text-sm font-medium text-gray-500">Total Bersih (Profit/Loss)</p>
                            <p class="text-2xl font-bold text-secondary mt-1">${formatRupiah(netTotal)}</p>
                        </div>
                    </div>

                    <!-- Cost Logging Section -->
                    <div class="pt-4 border-t">
                        <div class="flex justify-between items-center pb-3">
                            <h5 class="text-lg font-semibold text-gray-700">Detail Pencatatan Biaya</h5>
                            <button class="px-4 py-2 border border-secondary text-secondary font-medium rounded-lg hover:bg-secondary hover:text-white transition duration-150 flex items-center text-sm">
                                ${getIcon('plus', 'w-4 h-4 mr-2')} Catat Biaya Baru
                            </button>
                        </div>
                        <div class="overflow-x-auto rounded-lg border">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi Biaya</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nominal</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${costRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Tab Data Pendukung (Document Checklist and Master Data Link).
         * Disesuaikan dengan label "Data Pendukung" dari Flowchart.
         */
        function renderTabDataPendukung(division) {
            const documentChecklist = [
                { name: "KTP Penjual & Pembeli", required: true, received: true, file: "ktp_scanned.pdf" },
                { name: "Kartu Keluarga (KK)", required: true, received: false, file: null },
                { name: "Sertifikat Hak Milik (SHM) Asli", required: true, received: true, file: "shm_original.jpg" },
                { name: "PBB Terakhir Lunas", required: true, received: false, file: null },
                { name: "NPWP Pihak Terlibat", required: true, received: true, file: "npwp_all.pdf" },
                { name: "Surat Keterangan Waris (SKW)", required: false, received: false, file: null },
            ];

            const checklistItems = documentChecklist.map(doc => `
                <div class="flex justify-between items-center py-3 border-b last:border-b-0 hover:bg-gray-50 px-3 -mx-3 rounded-lg transition duration-150">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" ${doc.received ? 'checked' : ''} class="h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary" ${doc.received ? 'disabled' : ''}>
                        <div>
                            <span class="text-sm font-medium ${doc.received ? 'text-gray-900 line-through' : 'text-gray-700'}">${doc.name}</span>
                            <span class="text-xs ml-2 px-2 py-0.5 rounded-full ${doc.required ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600'}">${doc.required ? 'Wajib' : 'Opsional'}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        ${doc.file ? 
                            `<span class="text-xs text-secondary font-medium flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/></svg>
                                ${doc.file}
                            </span>` : 
                            `<button class="text-xs text-primary hover:text-indigo-700 font-medium border border-primary/50 px-3 py-1 rounded-lg hover:bg-primary/10">Upload Dokumen</button>`
                        }
                    </div>
                </div>
            `).join('');

            return `
                <div class="space-y-6">
                    <!-- Document Checklist -->
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-3">Data Pendukung: Checklist Dokumen Legal (${division.group})</h4>
                        <div class="space-y-2">
                            ${checklistItems}
                        </div>
                        <p class="text-xs text-gray-500 mt-4">Penting: Lengkapi semua dokumen wajib sebelum Tanggal Akad.</p>
                    </div>

                    <!-- Master Data Link -->
                    <div class="bg-indigo-50 p-5 rounded-xl shadow-inner border border-indigo-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Integrasi Master Data Bank</h4>
                        <p class="text-sm text-gray-600 mb-4">Lakukan konfigurasi data pihak (Penjual/Pembeli) dan data properti yang akan digunakan pada Akta Notaris/PPAT di modul Master Data Bank.</p>
                        <div class="flex flex-wrap gap-4">
                            <button class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-indigo-700 text-sm shadow-md">
                                Kelola Data Pihak Klien
                            </button>
                            <button class="px-4 py-2 border border-primary text-primary font-medium rounded-lg hover:bg-indigo-50 text-sm">
                                Kelola Data Properti/Aset
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        // --- ACTION HANDLERS ---

        function saveDivision(isEdit) {
            const name = document.getElementById('nama_divisi').value;
            const head = document.getElementById('kepala_divisi').value;
            const group = document.getElementById('grup_pekerjaan').value;
            const configNow = document.getElementById('config_now').checked;

            if (!name || !head || !group) {
                // In a real app, use a custom toast/modal
                console.error('Validation Error: Semua field wajib (*) harus diisi.');
                return;
            }

            console.log(`${isEdit === 'true' ? 'Updating' : 'Creating'} division:`, { name, head, group, configNow });

            // Mock Data Update/Create Logic
            if (isEdit === 'true') {
                // In a real application, you would save data here.
            } else {
                // Add new division to MOCK_DIVISIONS (Mocking new ID)
                const newId = MOCK_DIVISIONS.length + 1;
                MOCK_DIVISIONS.push({
                    id: newId,
                    name: name,
                    head: head,
                    group: group,
                    status: 'Aktif',
                    estimate: 'TBC',
                    job_type: '',
                    registration_no: '',
                    person_in_charge: head,
                    akta_date: '',
                    akta_place: '',
                    file_send_date: '',
                    notes: ''
                });
            }

            // Redirect based on 'configNow' checkbox
            updateState({ 
                modalOpen: false, 
                currentPage: configNow ? 'detail' : 'list',
                selectedDivision: configNow ? MOCK_DIVISIONS[MOCK_DIVISIONS.length - 1].id : null
            });
        }


        // --- MAIN RENDER FUNCTION ---

        function renderApp() {
            const appContainer = document.getElementById('app');
            const modalContainer = document.getElementById('modal-container');
            
            // Clear containers
            appContainer.innerHTML = '';
            modalContainer.innerHTML = '';

            // Render main page content
            let content;
            if (state.currentPage === 'list') {
                content = renderList();
            } else if (state.currentPage === 'detail') {
                content = renderDetail();
            }
            appContainer.appendChild(content);

            // Render modal if open
            modalContainer.innerHTML = renderPopupForm();
        }

        // Initialize the application
        window.onload = renderApp;
    </script>

</body>
</html>
